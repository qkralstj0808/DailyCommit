# CI/CD와 무중단 배포

### ***관련용어***

- 컴파일: 프로그래머가 작성한 소스코드를 기계어로 변환하는 과정 (한국어→ 영어로 번역)
- 빌드: 소스 코드 파일을 컴퓨터에서 실행할 수 있는 sw 산출물로 만드는 과정 (책 출간)
    - java에서는 `maven, gradle`과 같은 빌드 도구를 이용하면 컴파일과 함께 소스코드 파일을 `.jar, .war` 와 같은 산출물로 변환하는 빌드도 함께 할 수 있다.
- 배포: 빌드의 결과물을 사용자가 접근할 수 있는 환경에 배치하는 것 (서점)

# CI (Continous Intergration): 빌드&테스트 자동화

지속적 통합이라는 뜻으로 개발을 진행하면서도 품질을 관리할 수 있도록 여러 명이 하나의 코드애 대해서 수정을 진행해도 지속적으로 통합하면서 관리할 수 있음을 의미한다. 

![Untitled](CI%20CD%E1%84%8B%E1%85%AA%20%E1%84%86%E1%85%AE%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%83%E1%85%A1%E1%86%AB%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%208146b6c39a1246e48a1e94644a91b6d7/Untitled.png)

`개발자가 코드 병합을 요청하면 → CI tool이 Build와 Test를 진행함 → 이상이 없으면 코드를 병합/ 있다면 개발자에게 피드백 → CD → 서버에 자동으로 배포` 

**마틴 파울러가 제시하는 CI의 4가지 규칙**

- 모든 소스코드가 살아있고 누구든 현재의 소스에 접근할 수 있는 단일 지점을 유지할 것
- 빌드 프로세스를 자동화해서 누구든 소스로부터 시스템을 빌드할 수 있게 할 것
- 테스팅을 자동화해서 언제든지 시스템에 대한 건전한 테스트 수트를 실핼할 수 있게 할 것
- 누구든 현재 실행 파일을 얻으면 지금까지 가장 완전한 실행파일을 얻었다는 것을 확신하게 할 것

# CD (Continuous Deployment): 배포 자동화

CI의 연장선,  지속적 배포라는 뜻으로 빌드의 결과물을 프로덕션으로 릴리스 하는 작업을 자동화하는 것을 의마한다. 

## 지속적 재공과 지속적 배포

![Untitled](CI%20CD%E1%84%8B%E1%85%AA%20%E1%84%86%E1%85%AE%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%83%E1%85%A1%E1%86%AB%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%208146b6c39a1246e48a1e94644a91b6d7/Untitled%201.png)

지속적 제공과 지속적 배포의 차이는 deploy의 자동화 여부 

### CI/CD tool

- Jenkins
- Travis CI
- Github Actions

# 무중단 배포란?

말 그대로 애플리케이션의 중단없이 배포를 하는 것을 말한다.

애플리케이션 중단 시점 

![Untitled](CI%20CD%E1%84%8B%E1%85%AA%20%E1%84%86%E1%85%AE%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%83%E1%85%A1%E1%86%AB%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%208146b6c39a1246e48a1e94644a91b6d7/Untitled%202.png)

v1 서비스가 실행 중일 때 v2 버전을 다운로드 받는다.

v1 서비스를 종료 시키는 시점부터 v2를 시작하기 전까지 애플리케이션은 중단된다.

이렇게 서비스가 중단되는 시간을 다운타임(downtime)이라고 한다.

이런 문제를 해결하기위해 무중단 배포라는 개념이 나왔고 크게 3가지 방법이 있다.

### 무중단 배포 구현 방법

- AWS에서 Blue-Green 무중단 배포
- 도커를 이용한 무중단 배포
- L4, L7 스위치를 이용한 무중단 배포
- Nginx를 이용한 무중단 배포

### ***관련용어***

![Untitled](CI%20CD%E1%84%8B%E1%85%AA%20%E1%84%86%E1%85%AE%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%83%E1%85%A1%E1%86%AB%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%208146b6c39a1246e48a1e94644a91b6d7/Untitled%203.png)

**리버스 프록시** 

- 인터넷과 서버 사이에 위치한 중계 서버
- 클라이언트가 요청한 내용을 캐싱
- 서버 정보를 클라이언트로부터 숨길 수 있어 보안에 용이

![Untitled](CI%20CD%E1%84%8B%E1%85%AA%20%E1%84%86%E1%85%AE%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%83%E1%85%A1%E1%86%AB%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%208146b6c39a1246e48a1e94644a91b6d7/Untitled%204.png)

**로드 밸런싱** 

- 부하 분산
- 서버에 가해지는 부하를 분산해주는 역할
- 하나의 서버가 멈추더라도 서비스 중단없이 다른 서버가 서비스를 계속 유지할 수 있는 무중단 배포가 가능

# 무중단 배포 방식

![Untitled](CI%20CD%E1%84%8B%E1%85%AA%20%E1%84%86%E1%85%AE%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%83%E1%85%A1%E1%86%AB%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%208146b6c39a1246e48a1e94644a91b6d7/Untitled%205.png)

- 무중단 배포의 가장 기본적인 방식
- 인스턴스를 늘리지 않고 하나씩 새로운 버전으로 업데이트 시키는 기법
- **사용 중인 인스턴스 내에서 새 버전으로 점진적으로 교체**
- 버전간 호환성 문제가 생기는 순간이 있다.
- 사용중인 인스턴스에 트래픽이 몰리는 문제가 있다.

→ 서비스 중인 인스턴스 하나를 로드밸런서에서 라우팅하지 않도록 한 뒤, 새 버전을 적용하여 다시 라우팅하도록 한다.이를 반복하여 모든 인스턴스에 새 버전의 애플리케이션을 배포한다.

---

![Untitled](CI%20CD%E1%84%8B%E1%85%AA%20%E1%84%86%E1%85%AE%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%83%E1%85%A1%E1%86%AB%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%208146b6c39a1246e48a1e94644a91b6d7/Untitled%206.png)

- 잠재적 문제 상황을 미리 발견하기 위한 방식
- 신버전을 소수의 사용자들에게만 배포
- 문제가 없는 것이 확인되면 점진적으로 다른 서버에 신버전 배포
- **트래픽을 한 번에 확 바꾸는 것이 아니라 단계적으로 전환**하기에 부정적 영향을 최고화하고 상황에 따라 트래픽 양을 조절하며 롤백할 수 있다.
- 블루그린 배포와 유사, 하지만 블루그린은 한번에 전환, 이건 단계적 전환
- 문제 상황을 빠르게 감지 가능
- 구버전과 신버전의 공존으로 인한 호환성 문제

---

![Untitled](CI%20CD%E1%84%8B%E1%85%AA%20%E1%84%86%E1%85%AE%E1%84%8C%E1%85%AE%E1%86%BC%E1%84%83%E1%85%A1%E1%86%AB%20%E1%84%87%E1%85%A2%E1%84%91%E1%85%A9%208146b6c39a1246e48a1e94644a91b6d7/Untitled%207.png)

- Blue를 구버전, Green을 신버전으로 지칭
- 구버전과 동일하게 신버전의 인스턴스를 구성
- 운영 중인 구버전과 동일하게 신버전의 인스턴스를 구성한 후 **로드밸런서를 통해 모든 트래픽을 한번에 신버전 쪽으로 전환**하는 방식
- 구버전의 환경을 다음 배포에 재사용하거나 롤백하기 쉬움
- 단, 시스템 자원이 2배로 든다.